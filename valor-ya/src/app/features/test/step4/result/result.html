<app-valorya-description></app-valorya-description>
<app-stepper></app-stepper>

<div class="step-container">
  @if (isLoadingResult()) {
  <app-container-content
    title="Resultado del Predio"
    [showBackButton]="false"
    [showContinueButton]="false"
  >
    <div class="loading-section">
      <p class="loading-text">Cargando resultados del avalúo...</p>
    </div>
  </app-container-content>
  } @else if (errorLoadingResult()) {
  <app-container-content
    title="Resultado del Predio"
    [showContinueButton]="false"
    backButtonText="Nueva Consulta"
    (volver)="onNuevaConsulta()"
  >
    <div class="error-section">
      <p class="error-text">{{ errorLoadingResult() }}</p>
    </div>
  </app-container-content>
  } @else if (resultadoPrincipal && metadatos) {
  <app-container-content
    title="Resultado del Predio"
    [showBackButton]="false"
    [showContinueButton]="false"
  >
    <!-- Mapas -->
    <div class="maps-container">
      <!-- Mapa 1: Ubicación del Predio -->
      <div class="map-section">
        <h3 class="section-title">Ubicación del Predio</h3>
        <div class="map-wrapper">
          <app-map #mapPredio [config]="{ zoom: 16 }"></app-map>
        </div>
      </div>

      <!-- Mapa 2: Ofertas de Referencia -->
      <div class="map-section">
        <h3 class="section-title">Ofertas de Referencia</h3>
        <div class="map-wrapper">
          <app-map #mapOfertas [config]="{ zoom: 15 }"></app-map>
        </div>
      </div>
    </div>

    <!-- Resumen del Avalúo -->
    <div class="info-section">
      <h3 class="section-title">Resumen del Avalúo</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">Ofertas Utilizadas:</span>
          <span class="info-value">{{ formatInteger(metadatos.ofertas_utilizadas) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Ofertas Válidas:</span>
          <span class="info-value">{{ metadatos.chips_procesados }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Coeficiente de Variación (CV):</span>
          <span class="info-value">{{ formatNumber(resultadoPrincipal.CV) }}%</span>
        </div>
        <div class="info-item">
          <span class="info-label">Límite Inferior:</span>
          <span class="info-value">{{ formatCurrency(resultadoPrincipal.LIM_INFERIOR) }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Límite Superior:</span>
          <span class="info-value">{{ formatCurrency(resultadoPrincipal.LIM_SUPERIOR) }}</span>
        </div>
      </div>
    </div>

    <div class="info-section highlight-section">
      <h3 class="section-title">Valoración Final</h3>
      <div class="valuation-grid">
        <div class="valuation-item primary">
          <span class="valuation-label">Valor Ya</span>
          <span class="valuation-value">{{
            formatCurrency(resultadoPrincipal.VALOR_AVALUO_PREDIO)
          }}</span>
        </div>
        <div class="valuation-item">
          <span class="valuation-label">Valor por m²</span>
          <span class="valuation-value">{{ formatCurrency(resultadoPrincipal.MEDIA) }}</span>
        </div>
      </div>
    </div>

    <div class="actions-section-custom">
      <app-button
        text="Nueva Consulta"
        variant="secondary"
        type="button"
        (clicked)="onNuevaConsulta()"
      >
      </app-button>
      <app-button
        [text]="isDownloading() ? 'Generando PDF...' : 'Descargar Avalúo'"
        variant="primary"
        type="button"
        [disabled]="isDownloading()"
        (clicked)="onDescargarAvaluo()"
      >
      </app-button>
    </div>
  </app-container-content>
  }
</div>
